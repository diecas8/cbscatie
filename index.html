<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal Tumaco - Marcador de Puntos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f1a3d, #2a0845, #0f1a3d);
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            width: 100%;
            padding: 15px;
            gap: 15px;
        }
        
        .sidebar {
            width: 350px;
            background: rgba(15, 30, 60, 0.85);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .map-container {
            flex: 1;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 8px;
        }
        
        .layers-section {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #4CAF50;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .section-title i {
            margin-right: 10px;
            transition: transform 0.3s ease;
        }
        
        .section-title.active i {
            transform: rotate(90deg);
        }
        
        .layer-list {
            list-style: none;
        }
        
        .layer-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .layer-item:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: translateX(5px);
            border-color: rgba(76, 175, 80, 0.4);
        }
        
        .layer-item.active {
            background: rgba(76, 175, 80, 0.25);
            border-left: 4px solid #4CAF50;
        }
        
        .layer-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 8极 rgba(0, 0, 0, 0.3);
        }
        
        .layer-name {
            flex: 1;
            font-weight: 500;
            font-size: 1rem;
        }
        
        .layer-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            background: rgba(76, 175, 80, 0.4);
            transform: scale(1.1);
        }
        
        .position-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(15, 30, 60, 极0.85);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            max-width: 280px;
        }
        
        .position-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #4CAF50;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        
        .position-data {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .position-item {
            display: flex;
            justify-content: space-between;
        }
        
        .position-label {
            font-weight: 500;
            color: #6dd5ed;
        }
        
        .position-value {
            font-weight: 500;
        }
        
        .mobile-menu-btn {
            display: none;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(15, 30, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .point-form {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 30, 60, 0.95);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            z-index: 2000;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            border: 1px solid rgba(76, 175, 80, 0.4);
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4CAF50;
        }
        
        .form-header h2 {
            color: #4CAF50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-form {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-form:hover {
            color: #ff4b2b;
            transform: scale(1.1);
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4CAF50;
            font-weight: 500;
        }
        
        .form-group input, 
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(76, 175, 80, 0.3);
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            font-size: 1rem;
        }
        
        .form-group input:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, #56ab2f, #a8e063);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .form-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        
        .map-controls {
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(15, 30, 60, 0.9);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .control-btn:hover {
            background: rgba(76, 175, 80, 0.8);
            transform: scale(1.1);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 30, 60, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 2000;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(76, 175, 80, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        /* Colors for layers */
        .amenaza-color { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
        .se-amenaza-color { background: linear-gradient(135deg, #ff9a00, #ff5e00); }
        .conflicto-color { background: linear-gradient(135deg, #8e2de2, #4a00e0); }
        .ecosistemas-color { background: linear-gradient(135deg, #56ab2f, #a8e063); }
        .medios-vida-color { background: linear-gradient(135deg, #2193b0, #6dd5ed); }
        .sitio-color { background: linear-gradient(135deg, #FFD700, #FFA500); }
        
        /* Custom cursor for add point mode */
        .add-point-cursor {
            cursor: crosshair !important;
        }
        
        /* Pulse animation for points */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            70% { transform: scale(1.5); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        .add-another-container {
            margin-top: 15px;
            text-align: center;
        }
        
        .add-another-btn {
            background: none;
            border: none;
            color: #6dd5ed;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin: 0 auto;
        }
        
        .add-another-btn:hover {
            color: #4CAF50;
        }
        
        .instructions-content {
            margin-top: 10px;
            font-size: 0.95rem;
            line-height: 1.5;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease;
        }
        
        .instructions-content.active {
            max-height: 200px;
        }
        
        .search-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(15, 30, 60, 0.85);
            border-radius: 10px;
            padding: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            max-width: 300px;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(76, 175, 80, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .points-table-container {
            position: absolute;
            bottom: 30px;
            left: 20px;
            z-index: 1000;
            background: rgba(15, 30, 60, 0.85);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            max-height: 200px;
            overflow-y: auto;
            max-width: 350px;
            width: 100%;
            display: none;
        }
        
        .points-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .points-table th, .points-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .points-table th {
            color: #4CAF50;
            font-size: 0.9rem;
        }
        
        .points-table tr:hover {
            background: rgba(76, 175, 80, 0.1);
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10极px;
        }
        
        .table-header h3 {
            color: #4CAF50;
            font-size: 1.1rem;
        }
        
        .close-table {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }
        
        .export-options {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 30, 60, 0.95);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 350px;
            z-index: 2000;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            border: 1px solid rgba(76, 175, 80, 0.4);
        }
        
        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4CAF50;
        }
        
        .export-options h2 {
            color: #4CAF50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-option {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .export-option:hover {
            background: rgba(76, 175, 80, 0.2);
        }
        
        .export-option i {
            margin-right: 10px;
            font-size: 1.2rem;
            width: 30px;
            text-align: center;
        }
        
        .error-message {
            color: #ff4b2b;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        
        .credits {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 10px;
            }
            
            .sidebar {
                position: absolute;
                left: -100%;
                top: 0;
                bottom: 0;
                z-index: 1000;
                width: 85%;
                padding-top: 60px;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .map-container {
                height: 100%;
            }
            
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .map-controls {
                bottom: 20px;
                right: 20px;
            }
            
            .position-indicator {
                top: 80px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .layer-actions {
                flex-direction: column;
            }
            
            .point-form {
                width: 95%;
                padding: 15px;
            }
            
            .search-container {
                top: 80px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .points-table-container {
                max-height: 150px;
                max-width: 90%;
                left: 50%;
                transform: translateX(-50%);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <h1><i class="fas fa-map-marked-alt"></i> Geoportal Tumaco</h1>
                <p>Visualización de datos geoespaciales - Tumaco, Colombia</p>
            </div>
            
            <div class="layers-section">
                <h2 class="section-title"><i class="fas fa-layer-group"></i> Capas GeoJSON</h2>
                <ul class="layer-list">
                    <li class="layer-item" data-layer="amenaza">
                        <div class="layer-icon amenaza-color"><i class="fas fa-skull-crossbones"></i></div>
                        <div class="layer-name">PARES Amenaza</div>
                        <div class="layer-actions">
                            <button class="action-btn export-layer-btn" data-layer="amenaza" title="Exportar capa">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </li>
                    <li class="layer-item" data-layer="se_amenaza">
                        <div class="layer-icon se-amenaza-color"><i class="fas fa-radiation"></i></div>
                        <div class="layer-name">PARES SE Amenaza</div>
                        <div class="layer-actions">
                            <button class="action-btn export-layer-btn" data-layer="se_amenaza" title="Exportar capa">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </li>
                    <li class="layer-item" data-layer="conflicto">
                        <div class="layer-icon conflicto-color"><i class="fas fa-handshake-slash"></i></div>
                        <div class="layer-name">PARES Conflicto</div>
                        <div class="layer-actions">
                            <button class="action-btn export-layer-btn" data-layer="conflicto" title="Exportar capa">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </li>
                    <li class="layer-item" data-layer="ecosistemas">
                        <div class="layer-icon ecosistemas-color"><i class="fas fa-leaf"></i></div>
                        <div class="layer-name">PARES Ecosistemas</div>
                        <div class="layer-actions">
                            <button class="action-btn export-layer-btn" data-layer="ecosistemas" title="Exportar capa">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </li>
                    <li class="layer-item" data-layer="medios_vida">
                        <div class="layer-icon medios-vida-color"><i class="fas fa-hand-holding-heart"></i></div>
                        <div class="layer-name">PARES Medios de Vida</div>
                        <div class="layer-actions">
                            <button class="action-btn export-layer-btn" data-layer="medios_vida" title="Exportar capa">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </li>
                    <li class="layer-item" data-layer="sitio">
                        <div class="layer-icon sitio-color"><i class="fas fa-landmark"></i></div>
                        <div class="layer-name">Sitio</div>
                        <div class="layer-actions">
                            <button class="action-btn export-layer-btn" data-layer="sitio" title="Exportar capa">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </li>
                </ul>
            </div>
            
            <div class="instructions">
                <h2 class="section-title active" id="instructions-toggle">
                    <i class="fas fa-chevron-right"></i> <i class="fas fa-info-circle"></i> Instrucciones
                </h2>
                <div class="instructions-content active">
                    <p>
                        1. Selecciona una capa para activarla<br>
                        2. Haz clic en el mapa para marcar un punto<br>
                        3. Completa los detalles del punto<br>
                        4. Para editar: haz clic en un punto existente<br>
                        5. Exporta la capa con todos los puntos recolectados<br>
                        6. Usa la barra de búsqueda para ubicar lugares
                    </p>
                </div>
            </div>
            
            <div class="credits">
                Elaborado por Diego Castaño, Esp SIG, 2025
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            
            <div class="position-indicator">
                <div class="position-title">
                    <i class="fas fa-location-dot"></i> Posicionamiento
                </div>
                <div class="position-data">
                    <div class="position-item">
                        <span class="position-label">Latitud:</span>
                        <span class="position-value" id="current-lat">1.8067°</span>
                    </div>
                    <div class="position-item">
                        <span class="position-label">Longitud:</span>
                        <span class="position-value" id="current-lng">-78.7647°</span>
                    </div>
                    <div class="position-item">
                        <span class="position-label">Capa activa:</span>
                        <span class="position-value" id="active-layer">Ninguna</span>
                    </div>
                    <div class="position-item">
                        <span class="position-label">Puntos:</span>
                        <span class="position-value" id="points-count">0</span>
                    </div>
                </div>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-input" id="search-input" placeholder="Buscar ubicación...">
            </div>
            
            <div class="points-table-container" id="points-table">
                <div class="table-header">
                    <h3><i class="fas fa-table"></i> Puntos Registrados</h3>
                    <button class="close-table" id="close-table"><i class="fas fa-times"></i></button>
                </div>
                <table class="points-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Capa</th>
                        </tr>
                    </thead>
                    <tbody id="points-table-body">
                        <!-- Points will be added here dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div class="point-form" id="point-form">
                <div class="form-header">
                    <h2><i class="fas fa-map-marker-alt"></i> <span id="form-title">Detalles del Punto</span></h2>
                    <button class="close-form" id="close-form"><i class="fas fa-times"></i></button>
                </div>
                <div class="form-group">
                    <label for="point-id"><i class="fas fa-id-card"></i> ID del Punto *</label>
                    <input type="text" id="point-id" placeholder="Ingrese el ID único">
                    <div class="error-message" id="id-error">El ID es obligatorio</div>
                </div>
                <div class="form-group">
                    <label for="point-name"><i class="fas fa-tag"></i> Nombre del Punto *</label>
                    <input type="text" id="point-name" placeholder="Ingrese el nombre descriptivo">
                    <div class="error-message" id="name-error">El nombre es obligatorio</div>
                </div>
                <div class="form-group">
                    <label for="point-description"><i class="fas fa-align-left"></i> Descripción</label>
                    <textarea id="point-description" placeholder="Ingrese una descripción detallada"></textarea>
                </div>
                <button class="form-submit" id="save-point"><i class="fas fa-save"></i> <span id="save-btn-text">Guardar Punto</span></button>
                
                <div class="add-another-container">
                    <button class="add-another-btn" id="add-another-btn">
                        <i class="fas fa-plus-circle"></i> Agregar otro punto
                    </button>
                </div>
            </div>
        </div>
        
        <div class="map-controls">
            <div class="control-btn" id="zoom-in"><i class="fas fa-plus"></i></div>
            <div class="control-btn" id="zoom-out"><i class="fas fa-minus"></i></div>
            <div class="control-btn" id="locate-me"><i class="fas fa-location-arrow"></极i></div>
            <div class="control-btn" id="full-extent"><i class="fas fa-globe-americas"></i></div>
            <div class="control-btn" id="show-points"><i class="fas fa-table"></i></div>
        </div>
    </div>
    
    <button class="mobile-menu-btn" id="menu-toggle"><i class="fas fa-bars"></i></button>
    
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i> <span id="toast-message">Punto agregado exitosamente!</span>
    </div>

    <div class="export-options" id="export-options">
        <div class="export-header">
            <h2><i class="fas fa-file-export"></i> Exportar Capa</h2>
            <button class="close-form" id="close-export"><i class="fas fa-times"></i></button>
        </div>
        <p>Seleccione el formato de exportación:</p>
        <div class="export-option" data-format="geojson">
            <i class="fas fa-file-code"></i>
            <div>
                <strong>GeoJSON</strong>
                <p>Formato estándar para datos espaciales</p>
            </div>
        </div>
        <div class="export-option" data-format="csv">
            <i class="fas fa-file-csv"></i>
            <div>
                <strong>CSV</strong>
                <p>Formato de hoja de cálculo</p>
            </div>
        </div>
        <div class="export-option" data-format="kml">
            <i class="fas fa-file-alt"></i>
            <div>
                <strong>KML</strong>
                <p>Formato para Google Earth</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map with Tumaco coordinates
        const map = L.map('map', {
            center: [1.8067, -78.7647],
            zoom: 12,
            zoomControl: false
        });
        
        // Add ESRI base maps
        const esriWorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }).addTo(map);
        
        // Layer groups for GeoJSON data
        const layers = {
            amenaza: L.layerGroup(),
            se_amenaza: L.layerGroup(),
            conflicto: L.layerGroup(),
            ecosistemas: L.layerGroup(),
            medios_vida: L.layerGroup(),
            sitio: L.layerGroup()
        };
        
        // Store all collected points
        const collectedPoints = {
            amenaza: [],
            se_amenaza: [],
            conflicto: [],
            ecosistemas: [],
            medios_vida: [],
            sitio: []
        };
        
        // Store markers for editing
        const markers = {
            amenaza: [],
            se_amenaza: [],
            conflicto: [],
            ecosistemas: [],
            medios_vida: [],
            sitio: []
        };
        
        // Add layer groups to map
        Object.values(layers).forEach(layer => layer.addTo(map));
        
        // Custom icons for different point types
        const icons = {
            amenaza: L.divIcon({
                className: 'custom-icon',
                html: '<div class="icon-inner amenaza-color"><i class="fas fa-skull-crossbones"></i></div>',
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            }),
            se_amenaza: L.divIcon({
                className: 'custom-icon',
                html: '<div class="icon-inner se-amenaza-color"><i class="fas fa-radiation"></i></div>',
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            }),
            conflicto: L.divIcon({
                className: 'custom-icon',
                html: '<div class="icon-inner conflicto-color"><i class="fas fa-handshake-slash"></i></div>',
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            }),
            ecosistemas: L.divIcon({
                className: 'custom-icon',
                html: '<div class="icon-inner ecosistemas-color"><i class="fas fa-leaf"></i></div>',
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            }),
            medios_vida: L.divIcon({
                className: 'custom-icon',
                html: '<div class="icon-inner medios-vida-color"><i class="fas fa-hand-holding-heart"></i></div>',
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            }),
            sitio: L.divIcon({
                className: 'custom-icon',
                html: '<div class="icon-inner sitio-color"><i class="fas fa-landmark"></i></div>',
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            })
        };
        
        // State variables
        let activeLayer = null;
        let newPointPosition = null;
        let editingPoint = null;
        let currentExportLayer = null;
        
        // Toggle instructions visibility
        document.getElementById('instructions-toggle').addEventListener('click', function() {
            this.classList.toggle('active');
            document.querySelector('.instructions-content').classList.toggle('active');
        });
        
        // Layer activation functionality
        document.querySelectorAll('.layer-item').forEach(item => {
            item.addEventListener('click', function() {
                const layerName = this.getAttribute('data-layer');
                
                // Remove active class from all items
                document.querySelectorAll('.layer-item').forEach(i => {
                    i.classList.remove('active');
                });
                
                // Add active class to clicked item
                this.classList.add('active');
                
                // Set active layer
                activeLayer = layerName;
                document.getElementById('active-layer').textContent = this.querySelector('.layer-name').textContent;
                
                // Enable add point mode
                map.getContainer().classList.add('add-point-cursor');
                showToast(`Capa activada. Haz clic en el mapa para agregar un punto.`);
            });
        });
        
        // Add point on map click
        map.on('click', function(e) {
            if (activeLayer) {
                newPointPosition = e.latlng;
                editingPoint = null;
                
                // Open point form
                document.getElementById('point-form').style.display = 'block';
                document.getElementById('form-title').textContent = 'Nuevo Punto';
                document.getElementById('save-btn-text').textContent = 'Guardar Punto';
                
                // Reset form
                resetPointForm();
                
                // Show coordinates
                document.getElementById('current-lat').textContent = newPointPosition.lat.toFixed(5) + '°';
                document.getElementById('current-lng').textContent = newPointPosition.lng.toFixed(5) + '°';
            }
        });
        
        // Save point functionality
        document.getElementById('save-point').addEventListener('click', function() {
            if (validateForm()) {
                savePoint();
                document.getElementById('point-form').style.display = 'none';
                newPointPosition = null;
                editingPoint = null;
            }
        });
        
        // Add another point button
        document.getElementById('add-another-btn').addEventListener('click', function() {
            if (validateForm()) {
                savePoint();
                resetPointForm();
                showToast("Formulario listo para agregar otro punto");
            }
        });
        
        // Form validation
        function validateForm() {
            const pointId = document.getElementById('point-id').value;
            const pointName = document.getElementById('point-name').value;
            let valid = true;
            
            if (!pointId) {
                document.getElementById('id-error').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('id-error').style.display = 'none';
            }
            
            if (!pointName) {
                document.getElementById('name-error').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('name-error').style.display = 'none';
            }
            
            return valid;
        }
        
        // Function to save point
        function savePoint() {
            const pointId = document.getElementById('point-id').value;
            const pointName = document.getElementById('point-name').value;
            const pointDescription = document.getElementById('point-description').value;
            
            if (editingPoint) {
                // Edit existing point
                const point = collectedPoints[editingPoint.layer][editingPoint.index];
                const marker = markers[editingPoint.layer][editingPoint.index];
                
                // Update point data
                point.id = pointId;
                point.name = pointName;
                point.description = pointDescription;
                
                // Update marker
                marker.setPopupContent(`<b>${pointName}</b><br>ID: ${pointId}<br>${pointDescription}`);
                
                // Show success message
                showToast(`Punto "${pointName}" actualizado`);
            } else {
                // Create new point
                const marker = L.marker(newPointPosition, {icon: icons[activeLayer]})
                    .addTo(layers[activeLayer])
                    .bindPopup(`<b>${pointName}</b><br>ID: ${pointId}<br>${pointDescription}`);
                
                // Add click event for editing
                marker.on('click', function(e) {
                    // Find the point in collectedPoints
                    for (const layerName in collectedPoints) {
                        const points = collectedPoints[layerName];
                        for (let i = 0; i < points.length; i++) {
                            const point = points[i];
                            if (point.lat === e.latlng.lat && point.lng === e.latlng.lng) {
                                // Set editing state
                                editingPoint = { layer: layerName, index: i };
                                activeLayer = layerName;
                                document.getElementById('active-layer').textContent = layerName;
                                
                                // Open form in edit mode
                                document.getElementById('point-form').style.display = 'block';
                                document.getElementById('form-title').textContent = 'Editar Punto';
                                document.getElementById('save-btn-text').textContent = 'Actualizar Punto';
                                
                                // Fill form with point data
                                document.getElementById('point-id').value = point.id;
                                document.getElementById('point-name').value = point.name;
                                document.getElementById('point-description').value = point.description;
                                
                                // Show coordinates
                                document.getElementById('current-lat').textContent = point.lat.toFixed(5) + '°';
                                document.getElementById('current-lng').textContent = point.lng.toFixed(5) + '°';
                                
                                // Highlight marker
                                marker.getElement().classList.add('pulse');
                                setTimeout(() => {
                                    marker.getElement().classList.remove('pulse');
                                }, 2000);
                                break;
                            }
                        }
                    }
                });
                
                // Store point data
                collectedPoints[activeLayer].push({
                    id: pointId,
                    name: pointName,
                    description: pointDescription,
                    lat: newPointPosition.lat,
                    lng: newPointPosition.lng,
                    type: activeLayer
                });
                
                // Store marker reference
                markers[activeLayer].push(marker);
                
                // Add animation
                marker.getElement().classList.add('pulse');
                setTimeout(() => {
                    marker.getElement().classList.remove('pulse');
                }, 2000);
                
                // Show success message
                showToast(`Punto "${pointName}" agregado a la capa`);
                
                // Update points count
                updatePointsCount();
            }
        }
        
        // Update points count display
        function updatePointsCount() {
            let totalPoints = 0;
            for (const layer in collectedPoints) {
                totalPoints += collectedPoints[layer].length;
            }
            document.getElementById('points-count').textContent = totalPoints;
        }
        
        // Reset point form
        function resetPointForm() {
            document.getElementById('point-id').value = '';
            document.getElementById('point-name').value = '';
            document.getElementById('point-description').value = '';
            document.getElementById('point-id').focus();
            document.getElementById('id-error').style.display = 'none';
            document.getElementById('name-error').style.display = 'none';
        }
        
        // Export layer functionality
        document.querySelectorAll('.export-layer-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const layerName = this.getAttribute('data-layer');
                currentExportLayer = layerName;
                document.getElementById('export-options').style.display = 'block';
            });
        });
        
        // Export option selection
        document.querySelectorAll('.export-option').forEach(option => {
            option.addEventListener('click', function() {
                const format = this.getAttribute('data-format');
                exportLayer(currentExportLayer, format);
                document.getElementById('export-options').style.display = 'none';
            });
        });
        
        // Export layer to selected format
        function exportLayer(layerName, format) {
            if (collectedPoints[layerName].length === 0) {
                showToast(`La capa no contiene puntos para exportar`, true);
                return;
            }
            
            let data, mimeType, extension;
            
            if (format === 'geojson') {
                // Create GeoJSON features
                const features = collectedPoints[layerName].map(point => ({
                    type: "Feature",
                    properties: {
                        id: point.id,
                        name: point.name,
                        description: point.description,
                        type: point.type
                    },
                    geometry: {
                        type: "Point",
                        coordinates: [point.lng, point.lat]
                    }
                }));
                
                // Create GeoJSON object
                data = JSON.stringify({
                    type: "FeatureCollection",
                    features: features
                }, null, 2);
                
                mimeType = "application/json";
                extension = "geojson";
            } 
            else if (format === 'csv') {
                // Create CSV content
                let csvContent = "ID,Nombre,Descripción,Latitud,Longitud,Tipo\n";
                
                collectedPoints[layerName].forEach(point => {
                    csvContent += `"${point.id}","${point.name}","${point.description}",${point.lat},${point.lng},${point.type}\n`;
                });
                
                data = csvContent;
                mimeType = "text/csv";
                extension = "csv";
            }
            else if (format === 'kml') {
                // Create KML content
                let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
    <name>${layerName}</name>
    <description>Puntos exportados desde Geoportal Tumaco</description>`;
                
                collectedPoints[layerName].forEach(point => {
                    kmlContent += `
    <Placemark>
        <name>${point.name}</name>
        <description>ID: ${point.id}\n${point.description}</description>
        <Point>
            <coordinates>${point.lng},${point.lat},0</coordinates>
        </Point>
    </Placemark>`;
                });
                
                kmlContent += `
</Document>
</kml>`;
                
                data = kmlContent;
                mimeType = "application/vnd.google-earth.kml+xml";
                extension = "kml";
            }
            
            // Create blob and download
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `capa_${layerName}_tumaco.${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`Capa ${layerName} exportada como ${format.toUpperCase()} exitosamente!`);
        }
        
        // Close form
        document.getElementById('close-form').addEventListener('click', function() {
            document.getElementById('point-form').style.display = 'none';
            newPointPosition = null;
            editingPoint = null;
        });
        
        // Close export options
        document.getElementById('close-export').addEventListener('click', function() {
            document.getElementById('export-options').style.display = 'none';
        });
        
        // Map controls
        document.getElementById('zoom-in').addEventListener('click', function() {
            map.zoomIn();
        });
        
        document.getElementById('zoom-out').addEventListener('click', function() {
            map.zoomOut();
        });
        
        document.getElementById('full-extent').addEventListener('click', function() {
            map.setView([1.8067, -78.7647], 12);
            showToast('Vista restablecida a Tumaco');
        });
        
        document.getElementById('locate-me').addEventListener('click', function() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLocation = [position.coords.latitude, position.coords.longitude];
                    map.setView(userLocation, 15);
                    
                    // Add a marker at user location
                    L.marker(userLocation, {
                        icon: L.divIcon({
                            className: 'custom-icon',
                            html: '<div class="icon-inner" style="background: linear-gradient(135deg, #2193b0, #6dd5ed);"><i class="fas fa-user"></i></div>',
                            iconSize: [36, 36],
                            iconAnchor: [18, 36]
                        })
                    }).addTo(map)
                    .bindPopup('Tu ubicación actual')
                    .openPopup();
                    
                    showToast('Ubicación encontrada');
                }, function(error) {
                    showToast(`Error de ubicación: ${error.message}`, true);
                });
            } else {
                showToast('Geolocalización no disponible en este navegador', true);
            }
        });
        
        // Show points table
        document.getElementById('show-points').addEventListener('click', function() {
            const tableContainer = document.getElementById('points-table');
            const tableBody = document.getElementById('points-table-body');
            
            // Clear existing table rows
            tableBody.innerHTML = '';
            
            // Add points to table
            for (const layer in collectedPoints) {
                collectedPoints[layer].forEach(point => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${point.id}</td>
                        <td>${point.name}</td>
                        <td>${point.type}</td>
                    `;
                    
                    // Add click event to focus on the point
                    row.addEventListener('click', function() {
                        map.setView([point.lat, point.lng], 15);
                        
                        // Highlight the marker
                        const marker = markers[layer].find(m => 
                            m.getLatLng().lat === point.lat && 
                            m.getLatLng().lng === point.lng
                        );
                        
                        if (marker) {
                            marker.getElement().classList.add('pulse');
                            setTimeout(() => {
                                marker.getElement().classList.remove('pulse');
                            }, 2000);
                            marker.openPopup();
                        }
                    });
                    
                    tableBody.appendChild(row);
                });
            }
            
            tableContainer.style.display = 'block';
        });
        
        // Close points table
        document.getElementById('close-table').addEventListener('click', function() {
            document.getElementById('points-table').style.display = 'none';
        });
        
        // Mobile menu toggle
        document.getElementById('menu-toggle').addEventListener('click', function() {
            document.querySelector('.sidebar').classList.toggle('active');
        });
        
        // Update position indicator on map move
        map.on('move', function() {
            const center = map.getCenter();
            document.getElementById('current-lat').textContent = center.lat.toFixed(5) + '°';
            document.getElementById('current-lng').textContent = center.lng.toFixed(5) + '°';
        });
        
        // Search functionality
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    searchLocation(query);
                }
            }
        });
        
        // Function to search for a location using OpenStreetMap Nominatim
        function searchLocation(query) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);
                        
                        map.setView([lat, lon], 15);
                        
                        // Add a marker at the search result
                        L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'custom-icon',
                                html: '<div class="icon-inner" style="background: linear-gradient(135deg, #FFD700, #FFA500);"><i class="fas fa-search-location"></i></div>',
                                iconSize: [36, 36],
                                iconAnchor: [18, 36]
                            })
                        }).addTo(map)
                        .bindPopup(`<b>${result.display_name}</b>`)
                        .openPopup();
                        
                        showToast(`Ubicación encontrada: ${result.display_name}`);
                    } else {
                        showToast('Ubicación no encontrada', true);
                    }
                })
                .catch(error => {
                    showToast(`Error en la búsqueda: ${error.message}`, true);
                });
        }
        
        // Show toast notification
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            if (isError) {
                toast.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + message;
                toast.style.background = 'linear-gradient(to right, #ff416c, #ff4b2b)';
            } else {
                toast.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
                toast.style.background = 'linear-gradient(to right, #56ab2f, #a8e063)';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Load PARES_SE GeoJSON layer
        function loadPARES_SE() {
            // URL del GeoJSON (ruta local)
            const geojsonUrl = "J:/Mi unidad/Tumaco/geojson mapas/PARES_SE.geojson";
            
            fetch(geojsonUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar el GeoJSON');
                    }
                    return response.json();
                })
                .then(data => {
                    L.geoJSON(data, {
                        style: function(feature) {
                            return {
                                color: '#ff9a00',
                                weight: 3,
                                opacity: 0.7,
                                fillOpacity: 0.2
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                let content = '<div style="max-width:250px;">';
                                for (const key in feature.properties) {
                                    content += `<b>${key}:</b> ${feature.properties[key]}<br>`;
                                }
                                content += '</div>';
                                layer.bindPopup(content);
                            }
                        }
                    }).addTo(layers.se_amenaza);
                    
                    showToast('Capa PARES_SE cargada exitosamente!');
                })
                .catch(error => {
                    console.error('Error loading GeoJSON:', error);
                    showToast('Error cargando la capa PARES SE', true);
                });
        }
        
        // Initial position update
        const center = map.getCenter();
        document.getElementById('current-lat').textContent = center.lat.toFixed(5) + '°';
        document.getElementById('current-lng').textContent = center.lng.toFixed(5) + '°';
        updatePointsCount();
        
        // Load PARES_SE layer on startup
        loadPARES_SE();
    </script>
</body>
</html>